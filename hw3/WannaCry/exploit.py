import os
from IPython import embed
from reverse import getstatebits, getrandbits
def enc(data,key):
	cipher=""
	for i in range(len(data)):
		cipher+=chr(ord(data[i])^ord(key[i%len(key)]))
	return cipher
def unmerse(num):
	bigmask  = (1<<32) -1
	def unBitshiftRightXor(value, shift):
		i,result = 0,0
		while (i * shift) < 32 :
			partMask = (((bigmask << (32 - shift))&bigmask) >> (shift * i)) & bigmask 
			part = value & partMask
			value ^= part >> shift
			result |= part
			i += 1
  		return result
	def unBitshiftLeftXor(value, shift, mask):
		i = 0
		result = 0
		while (i * shift) < 32 :
			partMask = ((bigmask >> (32 - shift)) << (shift * i))&bigmask
			part = value & partMask
			value ^= (part << shift) & mask
			result |= part
			i += 1
		return result

	value = unBitshiftRightXor(num, 18)
	value = unBitshiftLeftXor(value, 15, 0xefc60000)
	value = unBitshiftLeftXor(value, 7, 0x9d2c5680)
	value = unBitshiftRightXor(value, 11)
	return value

def merse(tmp):
	tmp ^= (tmp >> 11)
	tmp ^= (tmp << 7) & 0x9d2c5680
	tmp ^= (tmp << 15) & 0xefc60000
	tmp ^= (tmp >> 18)
	return tmp

def rev(encrypt,decrypt):
	key = ""	
	for i in range(8):
		key += chr(ord(encrypt[i])^ord(decrypt[i]))
	#print(int(key.encode('hex').lstrip('0'),16))
	return int(key.encode('hex').lstrip('0'),16)

def gennextstate(state):
	for i in range(624):
		y = (state[i] & 0x80000000) + (state[(i + 1) % 624] & 0x7fffffff)
		ne = y >> 1
		ne ^= state[(i + 397) % 624]
		if y & 1:
			ne ^= 0x9908b0df
		state[i] = ne
	return state

seeds = []
N = 666

whitelist=["reverse.pyc","reverse.py","exploit.py","test.py","GannaPsy.py","decrypt.py","key.file"]
g = 1
for dirPath, dirNames, fileNames in os.walk("."):
	fileNames.sort()
	for files in fileNames:
		if files == "flag_666":
			g = 0
			break
		if files in whitelist:
			continue
		with open(dirPath+'/'+files,'rb') as fd, open('../gg/flagpool/{}'.format(files),'r') as fd1:
			encrypt,decrypt = fd.read(), fd1.read()
			assert(len(encrypt)==len(decrypt))
			seeds.append(rev(encrypt,decrypt))
	if not g:
		break
assert(g == 0)
state = []
#seeds = seeds[-312:]
# get only the last 312 @@

for i in seeds[-312:]:
	print(getstatebits(state,i,64))
key,_ = getrandbits(state,624,64)
key="{:0>16}".format(hex(key)[2:].replace("L","")).decode("hex")
print (key.encode('hex'))

k =  open('flag_{}'.format(N),'r').read()
print (k)
print(enc(k,key))


"""
for i in seeds:
	prefix  =unmerse( i >> 32)
	postfix  = unmerse(i & 0x7fffffff)
	state.append(prefix)
	state.append(postfix)
	assert(merse(prefix) == (i >> 32))
	assert(merse(postfix) == (i & 0x7fffffff))

state = gennextstate(state)
# here is crazy ???????????????????????????????

key =  (merse(state[0])<<32) + merse(state[1])
embed()
assert(key in seeds)
key="{:0>16}".format(hex(key)[2:].replace("L","")).decode("hex")
print (key.encode('hex'))

k =  open('flag_{}'.format(N),'r').read()
print (k)
print(enc(k,key))
"""
